<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Event Map - The Dog API</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        #map {
            height: 600px;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
        }

        .custom-popup .leaflet-popup-content {
            margin: 8px 12px;
            font-family: sans-serif;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen p-4 font-sans">
    <div class="max-w-6xl mx-auto">
        <header class="mb-6 flex justify-between items-center bg-gray-800 p-4 rounded-lg shadow-lg">
            <div>
                <h1 class="text-2xl font-bold text-orange-500">Live Event Map</h1>
                <p class="text-gray-400 text-sm">Real-time geolocation of API events</p>
            </div>
            <div class="flex items-center space-x-4">
                <div id="statusIndicator"
                    class="flex items-center space-x-2 bg-gray-900 px-3 py-1 rounded-full border border-gray-700">
                    <span class="w-2 h-2 rounded-full bg-gray-500"></span>
                    <span id="statusText" class="text-xs text-gray-400 font-mono uppercase">Disconnected</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Settings Panel -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-gray-800 p-5 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold mb-3 text-orange-400">Connection</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">WebSocket URL</label>
                            <input type="text" id="wsUrl" value="https://staging-api.thedogapi.com"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-orange-500 transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">API Key</label>
                            <input type="text" id="apiKey" placeholder="x-api-key"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-orange-500 transition-colors">
                        </div>
                        <!-- Attach Image Toggle -->
                        <div class="flex items-center space-x-2 py-2">
                            <input type="checkbox" id="attachImage" checked
                                class="w-4 h-4 text-orange-600 bg-gray-700 border-gray-600 rounded focus:ring-orange-500">
                            <label for="attachImage" class="text-sm font-medium text-gray-300">Attach Image
                                Details</label>
                        </div>
                        <div class="flex space-x-2 pt-2">
                            <button onclick="connect()" id="connectBtn"
                                class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded text-sm transition-colors">
                                Connect
                            </button>
                            <button onclick="disconnect()" id="disconnectBtn"
                                class="flex-1 bg-red-800 hover:bg-red-900 text-gray-300 font-bold py-2 px-4 rounded text-sm transition-colors hidden">
                                Disconnect
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 p-5 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold mb-3 text-orange-400">Recent Events</h2>
                    <div id="eventList" class="space-y-2 max-h-[400px] overflow-y-auto pr-1">
                        <div class="text-xs text-gray-500 italic text-center py-4">Waiting for events...</div>
                    </div>
                </div>
            </div>

            <!-- Map Panel -->
            <div class="lg:col-span-3 bg-gray-800 p-2 rounded-lg shadow-lg">
                <div id="map" class="w-full rounded bg-gray-900 z-0"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Country Centroids (ISO 3166-1 alpha-2) ---
        // Source: A simplified subset. You should expand this list for full coverage.
        const countryCentroids = {
            "AF": [33.93911, 67.709953],
            "AL": [41.153332, 20.168331],
            "DZ": [28.033886, 1.659626],
            "AS": [-14.270972, -170.132217],
            "AD": [42.546245, 1.601554],
            "AO": [-11.202692, 17.873887],
            "AI": [18.220554, -63.068615],
            "AQ": [-75.250973, -0.071389],
            "AG": [17.060816, -61.796428],
            "AR": [-38.416097, -63.616672],
            "AM": [40.069099, 45.038189],
            "AW": [12.52111, -69.968338],
            "AU": [-25.274398, 133.775136],
            "AT": [47.516231, 14.550072],
            "AZ": [40.143105, 47.576927],
            "BS": [25.03428, -77.39628],
            "BH": [26.0667, 50.5577],
            "BD": [23.684994, 90.356331],
            "BB": [13.193887, -59.543198],
            "BY": [53.709807, 27.953389],
            "BE": [50.503887, 4.469936],
            "BZ": [17.189877, -88.49765],
            "BJ": [9.30769, 2.315834],
            "BM": [32.321384, -64.75737],
            "BT": [27.514162, 90.433601],
            "BO": [-16.290154, -63.588653],
            "BA": [43.915886, 17.679076],
            "BW": [-22.328474, 24.684866],
            "BV": [-54.423199, 3.413194],
            "BR": [-14.235004, -51.92528],
            "IO": [-6.343194, 71.876519],
            "BN": [4.535277, 114.727669],
            "BG": [42.733883, 25.48583],
            "BF": [12.238333, -1.561593],
            "BI": [-3.373056, 29.918886],
            "KH": [12.565679, 104.990963],
            "CM": [7.369722, 12.354722],
            "CA": [56.130366, -106.346771],
            "CV": [16.002082, -24.013197],
            "KY": [19.513469, -80.566956],
            "CF": [6.611111, 20.939444],
            "TD": [15.454166, 18.732207],
            "CL": [-35.675147, -71.542969],
            "CN": [35.86166, 104.195397],
            "CX": [-10.447525, 105.690449],
            "CC": [-12.164165, 96.870956],
            "CO": [4.570868, -74.297333],
            "KM": [-11.875001, 43.872219],
            "CG": [-0.228021, 15.827659],
            "CD": [-4.038333, 21.758664],
            "CK": [-21.236736, -159.777671],
            "CR": [9.748917, -83.753428],
            "CI": [7.539989, -5.54708],
            "HR": [45.1, 15.2],
            "CU": [21.521757, -77.781167],
            "CY": [35.126413, 33.429859],
            "CZ": [49.817492, 15.472962],
            "DK": [56.26392, 9.501785],
            "DJ": [11.825138, 42.590275],
            "DM": [15.414999, -61.276987],
            "DO": [18.735693, -70.162651],
            "EC": [-1.831239, -78.183406],
            "EG": [26.820553, 30.802498],
            "SV": [13.794185, -88.89653],
            "GQ": [1.650801, 10.267895],
            "ER": [15.179384, 39.782334],
            "EE": [58.595272, 25.013607],
            "ET": [9.145, 40.489673],
            "FK": [-51.796253, -59.523613],
            "FO": [61.892635, -6.911806],
            "FJ": [-17.713371, 178.065032],
            "FI": [61.92411, 25.748151],
            "FR": [46.227638, 2.213749],
            "GF": [3.933889, -53.125782],
            "PF": [-17.679742, -149.406843],
            "TF": [-49.280366, 69.348557],
            "GA": [-0.803689, 11.609444],
            "GM": [13.443182, -15.310139],
            "GE": [42.315407, 43.356892],
            "DE": [51.165691, 10.451526],
            "GH": [7.946527, -1.023194],
            "GI": [36.140751, -5.353585],
            "GR": [39.074208, 21.824312],
            "GL": [71.706936, -42.604303],
            "GD": [12.1165, -61.679],
            "GP": [16.995971, -62.067641],
            "GU": [13.444304, 144.793731],
            "GT": [15.783471, -90.230759],
            "GN": [9.945587, -9.696645],
            "GW": [11.803749, -15.180413],
            "GY": [4.860416, -58.93018],
            "HT": [18.971187, -72.285215],
            "HM": [-53.106576, 72.511333],
            "VA": [41.902916, 12.453389],
            "HN": [15.199999, -86.241905],
            "HK": [22.396428, 114.109497],
            "HU": [47.162494, 19.503304],
            "IS": [64.963051, -19.020835],
            "IN": [20.593684, 78.96288],
            "ID": [-0.789275, 113.921327],
            "IR": [32.427908, 53.688046],
            "IQ": [33.223191, 43.679291],
            "IE": [53.41291, -8.24389],
            "IL": [31.046051, 34.851612],
            "IT": [41.87194, 12.56738],
            "JM": [18.109581, -77.297508],
            "JP": [36.204824, 138.252924],
            "JO": [30.585164, 36.238414],
            "KZ": [48.019573, 66.923684],
            "KE": [-0.023559, 37.906193],
            "KI": [-3.370417, -168.734039],
            "KP": [40.339852, 127.510093],
            "KR": [35.907757, 127.766922],
            "KW": [29.31166, 47.481766],
            "KG": [41.20438, 74.766098],
            "LA": [19.85627, 102.495496],
            "LV": [56.879635, 24.603189],
            "LB": [33.854721, 35.862285],
            "LS": [-29.609988, 28.233608],
            "LR": [6.428055, -9.429499],
            "LY": [26.3351, 17.228331],
            "LI": [47.166, 9.555373],
            "LT": [55.169438, 23.881275],
            "LU": [49.815273, 6.129583],
            "MO": [22.198745, 113.543873],
            "MK": [41.608635, 21.745275],
            "MG": [-18.766947, 46.869107],
            "MW": [-13.254308, 34.301525],
            "MY": [4.210484, 101.975766],
            "MV": [3.202778, 73.22068],
            "ML": [17.570692, -3.996166],
            "MT": [35.937496, 14.375416],
            "MH": [7.131474, 171.184478],
            "MQ": [14.641528, -61.024174],
            "MR": [21.00789, -10.940835],
            "MU": [-20.348404, 57.552152],
            "YT": [-12.8275, 45.166244],
            "MX": [23.634501, -102.552784],
            "FM": [7.425554, 150.550812],
            "MD": [47.411631, 28.369885],
            "MC": [43.750298, 7.412841],
            "MN": [46.862496, 103.846656],
            "ME": [42.708678, 19.37439],
            "MS": [16.742498, -62.187366],
            "MA": [31.791702, -7.09262],
            "MZ": [-18.665695, 35.529562],
            "MM": [21.916221, 95.955974],
            "NA": [-22.95764, 18.49041],
            "NR": [-0.522778, 166.931503],
            "NP": [28.394857, 84.124008],
            "NL": [52.132633, 5.291266],
            "AN": [12.226079, -69.060087],
            "NC": [-20.904305, 165.618042],
            "NZ": [-40.900557, 174.885971],
            "NI": [12.865416, -85.207229],
            "NE": [17.607789, 8.081666],
            "NG": [9.081999, 8.675277],
            "NU": [-19.054445, -169.867233],
            "NF": [-29.040835, 167.954712],
            "MP": [17.33083, 145.38469],
            "NO": [60.472024, 8.468946],
            "OM": [21.512583, 55.923255],
            "PK": [30.375321, 69.345116],
            "PW": [7.51498, 134.58252],
            "PS": [31.952162, 35.233154],
            "PA": [8.537981, -80.782127],
            "PG": [-6.314993, 143.95555],
            "PY": [-23.442503, -58.443832],
            "PE": [-9.189967, -75.015152],
            "PH": [12.879721, 121.774017],
            "PN": [-24.703615, -127.439308],
            "PL": [51.919438, 19.145136],
            "PT": [39.399872, -8.224454],
            "PR": [18.220833, -66.590149],
            "QA": [25.354826, 51.183884],
            "RE": [-21.115141, 55.536384],
            "RO": [45.943161, 24.96676],
            "RU": [61.52401, 105.318756],
            "RW": [-1.940278, 29.873888],
            "SH": [-15.965001, -5.708913],
            "KN": [17.357822, -62.782998],
            "LC": [13.909444, -60.978893],
            "PM": [46.941936, -56.27111],
            "VC": [12.984305, -61.287228],
            "WS": [-13.759029, -172.104629],
            "SM": [43.94236, 12.457777],
            "ST": [0.18636, 6.613081],
            "SA": [23.885942, 45.079162],
            "SN": [14.497401, -14.452362],
            "RS": [44.016521, 21.005859],
            "SC": [-4.679574, 55.491977],
            "SL": [8.460555, -11.779889],
            "SG": [1.352083, 103.819836],
            "SK": [48.669026, 19.699024],
            "SI": [46.151241, 14.995463],
            "SB": [-9.64571, 160.156194],
            "SO": [5.152149, 46.199616],
            "ZA": [-30.559482, 22.937506],
            "GS": [-54.429579, -36.587909],
            "ES": [40.463667, -3.74922],
            "LK": [7.873054, 80.771797],
            "SD": [12.862807, 30.217636],
            "SR": [3.919305, -56.027783],
            "SJ": [77.553604, 23.670272],
            "SZ": [-26.522503, 31.465866],
            "SE": [60.128161, 18.643501],
            "CH": [46.818188, 8.227512],
            "SY": [34.802075, 38.996815],
            "TW": [23.69781, 120.960515],
            "TJ": [38.861034, 71.276093],
            "TZ": [-6.369028, 34.888822],
            "TH": [15.870032, 100.992541],
            "TL": [-8.874217, 125.727539],
            "TG": [8.619543, 0.824782],
            "TK": [-8.967363, -171.855881],
            "TO": [-21.178986, -175.198242],
            "TT": [10.691803, -61.222503],
            "TN": [33.886917, 9.537499],
            "TR": [38.963745, 35.243322],
            "TM": [38.969719, 59.556278],
            "TC": [21.694025, -71.797928],
            "TV": [-7.109535, 177.64933],
            "UG": [1.373333, 32.290275],
            "UA": [48.379433, 31.16558],
            "AE": [23.424076, 53.847818],
            "GB": [55.378051, -3.435973],
            "US": [37.09024, -95.712891],
            "UM": [19.282933, 166.618667],
            "UY": [-32.522779, -55.765835],
            "UZ": [41.377491, 64.585262],
            "VU": [-15.376706, 166.959158],
            "VE": [6.42375, -66.58973],
            "VN": [14.058324, 108.277199],
            "VG": [18.420695, -64.639968],
            "VI": [18.335765, -64.896335],
            "WF": [-13.769389, -177.156097],
            "EH": [24.215527, -12.885834],
            "YE": [15.552727, 48.516388],
            "ZM": [-13.133897, 27.849332],
            "ZW": [-19.015438, 29.154857]
        };

        // --- Init Map ---
        const map = L.map('map').setView([20, 0], 2); // Center world
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- Socket Logic ---
        let socket;
        let popupTimer = null;
        const wsUrlInput = document.getElementById('wsUrl');
        const apiKeyInput = document.getElementById('apiKey');
        const attachImageInput = document.getElementById('attachImage');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusText = document.getElementById('statusText');
        const statusIndicator = document.querySelector('#statusIndicator span');
        const eventList = document.getElementById('eventList');

        // Load saved values
        if (localStorage.getItem('ws_url')) wsUrlInput.value = localStorage.getItem('ws_url');

        const savedKey = localStorage.getItem('ws_api_key');
        if (savedKey) {
            apiKeyInput.value = savedKey;
        } else {
            apiKeyInput.value = 'DEMO-API-KEY';
        }

        if (localStorage.getItem('ws_attach_image')) {
            attachImageInput.checked = localStorage.getItem('ws_attach_image') === 'true';
        }

        function updateStatus(status, color) {
            statusText.innerText = status;
            statusIndicator.className = `w-2 h-2 rounded-full bg-${color}-500 ${status === 'Connecting...' ? 'animate-pulse' : ''}`;

            if (status === 'Connected') {
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
                wsUrlInput.disabled = true;
                apiKeyInput.disabled = true;
                attachImageInput.disabled = true;
            } else {
                connectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('hidden');
                wsUrlInput.disabled = false;
                apiKeyInput.disabled = false;
                attachImageInput.disabled = false;
            }
        }

        function addEventToList(eventStr, type = 'info', hasImage = false) {
            const el = document.createElement('div');
            el.className = `p-2 rounded bg-gray-700 text-xs border-l-2 custom-event-item`;

            let colorClass = 'border-gray-500';
            if (type === 'vote') colorClass = 'border-blue-500';
            if (type === 'favourite') colorClass = 'border-pink-500';
            if (type === 'upload') colorClass = 'border-green-500';

            el.classList.add(colorClass);

            const time = new Date().toLocaleTimeString();
            let content = `<span class="text-gray-400 font-mono mr-1">${time}</span> ${eventStr}`;

            if (hasImage) {
                content += ` <span class="text-xs bg-orange-900 text-orange-200 px-1 rounded ml-1">IMG</span>`;
            }

            el.innerHTML = content;

            eventList.prepend(el);
            if (eventList.children.length > 20) {
                eventList.lastElementChild.remove();
            }
        }

        function createMapMarker(lat, lng, eventName, countryCode, data) {
            let imageHtml = '';
            if (data && data.image && data.image.url) {
                imageHtml = `<div class="mb-2"><img src="${data.image.url}" class="w-full h-24 object-cover rounded" alt="Event Image"></div>`;
            }

            const popupContent = `
                ${imageHtml}
                <div class="font-bold text-orange-600 mb-1 capitalize">${eventName}</div>
                <div class="text-sm text-gray-700">Country: <b>${countryCode}</b></div>
                <div class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString()}</div>
            `;

            if (popupTimer) {
                clearTimeout(popupTimer);
                popupTimer = null;
            }

            L.popup({
                closeButton: false,
                // autoClose: false, // Removed to allow default behavior (closing other popups)
                closeOnClick: false,
                className: 'custom-popup'
            })
                .setLatLng([lat, lng])
                .setContent(popupContent)
                .openOn(map);

            // Auto close after 5 seconds to allow seeing the image
            popupTimer = setTimeout(() => {
                map.closePopup();
                popupTimer = null;
            }, 5000);
        }

        function connect() {
            const url = wsUrlInput.value;
            let apiKey = apiKeyInput.value;
            const attachImage = attachImageInput.checked;

            if (!apiKey) {
                apiKey = 'DEMO-API-KEY';
                apiKeyInput.value = apiKey;
            }

            if (!url) {
                alert('Please provide URL');
                return;
            }

            localStorage.setItem('ws_url', url);
            localStorage.setItem('ws_api_key', apiKey);
            localStorage.setItem('ws_attach_image', attachImage);

            if (socket) socket.disconnect();

            updateStatus('Connecting...', 'yellow');

            socket = io(url, {
                transports: ['websocket'],
                auth: {
                    'x-api-key': apiKey,
                    'attach_image': attachImage ? 'true' : 'false'
                },
                extraHeaders: {
                    'x-api-key': apiKey,
                    'attach_image': attachImage ? 'true' : 'false'
                }
            });

            socket.on('connect', () => {
                updateStatus('Connected', 'green');
                addEventToList('Connected to WebSocket Gateway');
                if (eventList.querySelector('.italic')) eventList.innerHTML = '';
            });

            socket.on('connect_error', (err) => {
                updateStatus('Error', 'red');
                addEventToList(`Connection Error: ${err.message}`);
            });

            socket.on('disconnect', () => {
                updateStatus('Disconnected', 'gray');
                addEventToList('Disconnected');
            });

            socket.onAny((eventName, data) => {
                let countryCode = null;
                let hasImage = false;

                if (data && data._metadata.country_code) countryCode = data._metadata.country_code;
                if (!countryCode && data && data.sub_id) {
                    // Sometimes sub_id might be used for testing country? Unlikely but fallback
                }
                if (data._metadata.event_type) {
                    eventName = data._metadata.event_type;
                }

                if (!countryCode && data && data.sub_id) { }

                if (data && data.image) {
                    hasImage = true;
                }

                addEventToList(`Event: <b>${eventName}</b> ${countryCode ? `(${countryCode})` : ''}`, eventName, hasImage);

                if (countryCode) {
                    const coords = countryCentroids[countryCode.toUpperCase()];
                    if (coords) {
                        createMapMarker(coords[0], coords[1], eventName, countryCode, data);
                    } else {
                        console.warn('Coordinates not found for country:', countryCode);
                    }
                }
            });
        }

        function disconnect() {
            if (socket) socket.disconnect();
        }
    </script>
</body>

</html>